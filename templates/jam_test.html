{% extends "base.html" %}

{% block content %}
<div class="container">
    <h1 class="mt-4">Jam Test</h1>
    <h2>Sampler: {{ sampler.name }}</h2>
    {% if message %}
    <div class="alert alert-danger" role="alert">
        {{ message }}
    </div>
    {% endif %}
    <div class="mb-4">
        <h3>Manual Note Control</h3>
        <div class="form-group">
            <label for="note">MIDI Note Number</label>
            <input type="number" class="form-control" id="note" name="note" required>
        </div>
        <div class="form-group">
            <label for="preset">Select Preset</label>
            <select id="preset" class="form-control" required>
                {% for id, name in presets %}
                <option value="{{ id }}">{{ name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="form-group">
            <input type="hidden" class="form-control" id="instrument-name" name="instrument-name">
        </div>
        <button onclick="sendNoteAction('note_on')" class="btn btn-outline-primary mt-2"><i class="fa-solid fa-play"></i></button>
        <button onclick="sendNoteAction('note_off')" class="btn btn-secondary mt-2"><i class="fa-solid fa-pause"></i></button>
        <button onclick="saveInstrument('{{ sampler.filename }}')" class="btn btn-outline-warning mt-2"><i class="fa-solid fa-floppy-disk"></i></button>
        <div class="alert alert-danger d-none" role="alert" id="response-err-msg"></div>
        <div class="alert alert-success d-none" role="alert" id="response-msg"></div>
        <form method="get" action="{{ url_for('device.device') }}" class="mt-4">
            <input type="hidden" name="sampler_id" value="{{ sampler.id }}">
            <input type="hidden" name="preset" id="preset-form">
            <button type="submit" class="btn btn-outline-success mb-3" style="float: right;"><i class="fa-solid fa-plug"></i></button>
        </form>
    </div>
</div>
<script src="{{ url_for('static', filename='js/bootstrap.bundle.min.js') }}"></script>
<script>
    document.getElementById('preset').addEventListener('change', function() {
        document.getElementById('preset-form').value = this.value;
    });

    document.getElementById('preset-form').value = document.getElementById('preset').value;

    async function sendNoteAction(action) {
        const note = document.getElementById('note').value;
        if (!note) {
            document.getElementById('note').focus();
            document.getElementById("response-err-msg").innerHTML = "Error: Note number can't be none";
            document.getElementById("response-msg").classList.add('d-none');
            document.getElementById("response-err-msg").classList.remove('d-none');
            return;
        }
        const preset = document.getElementById('preset').value;
        try {
            const response = await fetch("{{ url_for('jam_test.send_note') }}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ note: note, action: action, preset: preset })
            });
            const result = await response.json();
            if (response.ok) {
                document.getElementById("response-msg").innerHTML = result.status + ": " + result.action + " note " + result.note;
                document.getElementById("response-msg").classList.remove('d-none');
                document.getElementById("response-err-msg").classList.add('d-none');
            } else {
                document.getElementById("response-err-msg").innerHTML = result.status + ": " + result.message;
                document.getElementById("response-msg").classList.add('d-none');
                document.getElementById("response-err-msg").classList.remove('d-none');
            }
        } catch (error) {
            document.getElementById("response-err-msg").innerHTML = "Error: " + error.message;
            document.getElementById("response-msg").classList.add('d-none');
            document.getElementById("response-err-msg").classList.remove('d-none');
        }
    }

    async function saveInstrument(source) {
        const preset = document.getElementById('preset').value;
        const presetName = document.getElementById('preset').selectedOptions[0].text;
        let instrumentName = document.getElementById('instrument-name').value;

        if (!instrumentName) {
            instrumentName = prompt("Enter name for the instrument:", presetName);
            if (!instrumentName) {
                alert("Instrument name is required.");
                return;
            }
        }

        try {
            const response = await fetch("{{ url_for('instrument.save_instrument') }}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ name: instrumentName, instrument_type: 'soundfont', source: source, preset: preset })
            });
            const result = await response.json();
            if (response.ok) {
                document.getElementById("response-msg").innerHTML = result.status + ": " + result.message;
                document.getElementById("response-msg").classList.remove('d-none');
                document.getElementById("response-err-msg").classList.add('d-none');
            } else {
                document.getElementById("response-err-msg").innerHTML = result.status + ": " + result.message;
                document.getElementById("response-msg").classList.add('d-none');
                document.getElementById("response-err-msg").classList.remove('d-none');
            }
        } catch (error) {
            document.getElementById("response-err-msg").innerHTML = "Error: " + error.message;
            document.getElementById("response-msg").classList.add('d-none');
            document.getElementById("response-err-msg").classList.remove('d-none');
        }
    }
</script>

{% endblock %}
